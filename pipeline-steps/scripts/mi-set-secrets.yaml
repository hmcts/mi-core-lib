name: '$(SourceBranchName)-$(Build.SourceVersion) Build-$(Build.BuildId)'

parameters:
  - name: env
    displayName: Environment to deploy
    type: string
    default: sbox
    values:
      - sbox
      - dev
      - test
      - stg
      - ithc
      - prod

trigger: none
pr: none

stages:
  - stage: DeployAzureVaultSecrets
    jobs:
      - job: 'DeployAzureVaultSecrets_${{ parameters.env }}'
        pool:
          vmImage: 'Ubuntu-16.04'
        variables:
          - group: 'mi-env-${{ parameters.env }}'
        steps:
          - template: ../templates/steps/refresh-var-group-conn-strings.yaml
            parameters:
              azureSubscriptionEndpoint: 'DTS-SHAREDSERVICES-${{ upper(parameters.env) }}'
              env: '${{ parameters.env }}'
          - template: ../templates/steps/vault-upload.yaml
            parameters:
              azureSubscriptionEndpoint: 'DTS-SHAREDSERVICES-${{ upper(parameters.env) }}'
              azureVault: 'mi-vault-${{ parameters.env }}'
              keyMapping: #mapping with secreate name and variable name
                - secret_name: mi-extraction-storage-connection-string
                  env_var_name: mi-extraction-storage-connection-string
                - secret_name: mi-landing-storage-connection-string
                  env_var_name: mi-landing-storage-connection-string
                - secret_name: mi-staging-storage-connection-string
                  env_var_name: mi-staging-storage-connection-string
                - secret_name: mi-export-storage-connection-string
                  env_var_name: mi-export-storage-connection-string
                - secret_name: mi-audit-storage-connection-string
                  env_var_name: mi-audit-storage-connection-string
                - secret_name: mi-polybase-storage-connection-string
                  env_var_name: mi-polybase-storage-connection-string
