parameters:
  azureSubscriptionEndpoint: $(azure.subscription.endpoint)
  azureVault: ''
  secretName: ''
  appendValue: ''

steps:
  - task: AzureCLI@2
    displayName: "Append to vault secret ${{ parameters.secretName }}"
    inputs:
      azureSubscription: ${{ parameters.azureSubscriptionEndpoint }}
      scriptType: 'bash'
      scriptLocation: "inlineScript"
      inlineScript: |
        seachedSecret=$(az keyvault secret list --vault-name ${{ parameters.azureVault }}  --query "[?name=='${{ parameters.secretName }}'].name" -o tsv)
        if [ -z "$seachedSecret" ]; then
            echo "Secret doesn't exist. Run mi-set-secrets DeployAzureVaultSecrets instead."
        else
            currentValue=$(az keyvault secret show --vault-name ${{ parameters.azureVault }} --name ${{ parameters.secretName }} --query 'value' -o tsv)
            appendValue="${currentValue}${{ parameters.appendValue}}"
            az keyvault secret set --name ${{ parameters.secretName }} --vault-name ${{ parameters.azureVault }}  --value "${appendValue}" --output none
            echo "Updated secret in vault by appending the parameter appendValue."
        fi
