parameters:
  helmVersion: '3.0.0'
  azureContainerRegistry: ''
  azureSubscriptionEndpoint: ''
  applicationName: ''
  aksResourceGroup: ''
  aksCluster: ''
  jobName: ''
  namespace: ''
  chartEnv: ''
  helmRepo: 'hmctspublic'

steps:
  - template: ./steps/docker-tag.yaml
  - task: HelmInstaller@1
    displayName: 'Install Helm ${{ parameters.helmVersion }}'
    inputs:
      helmVersionToInstall: ${{ parameters.helmVersion }}
  - task: AzureCLI@1
    displayName: "AKS Authenticate"
    inputs:
      azureSubscription: ${{ parameters.azureSubscriptionEndpoint }}
      scriptLocation: "inlineScript"
      inlineScript: az aks get-credentials --admin --resource-group ${{ parameters.aksResourceGroup }} --name ${{ parameters.aksCluster }}
  - script: |
      envsubst < charts/${{ parameters.applicationName }}/values.${{ parameters.chartEnv }}.template.yaml > charts/${{ parameters.applicationName }}/values.${{ parameters.chartEnv }}.yaml
    displayName: 'Replace Image Name In Chart Values'
    env:
      IMAGE_NAME: '${{ parameters.azureContainerRegistry }}/${{ parameters.applicationName }}:$(imageTag)'
  - task: AzureCLI@1
    displayName: "Helm Install Job Chart"
    env:
      BUILD_NUMBER: $(Build.BuildId)
    inputs:
      azureSubscription: ${{ parameters.azureSubscriptionEndpoint }}
      scriptLocation: "inlineScript"
      inlineScript: |
        echo "the build number is : $(Build.BuildId)"
        helm repo add ${{ parameters.helmRepo }} https://${{ parameters.helmRepo }}.azurecr.io/helm/v1/repo
        helm dependency update charts/${{ parameters.applicationName }}
        helm install ${{ parameters.jobName }}-$(imageSha)-$(Build.BuildId) charts/${{ parameters.applicationName }} --namespace ${{ parameters.namespace }} -f charts/${{ parameters.applicationName }}/values.yaml -f charts/${{ parameters.applicationName }}/values.${{ parameters.chartEnv }}.yaml 